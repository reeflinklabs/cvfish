<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - CVFish</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/daisyui/dist/full.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@1000&family=Poppins:wght@500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="output.css" />
    <style>
      .truncate {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
      }
      table {
        table-layout: auto;
        width: 100%;
      }
      th,
      td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 0.5rem 1rem;
      }
      .status-badge {
        display: inline-block;
        min-width: 100px;
      }
      .no-truncate {
        white-space: nowrap;
        overflow: visible;
        text-overflow: clip;
      }
      @media (max-width: 640px) {
        th,
        td {
          white-space: normal;
        }
        .status-badge {
          min-width: auto;
        }
      }
    </style>
  </head>
  <body class="font-body bg-base-300 min-h-screen">
    <header class="bg-primary text-white p-4">
      <div class="max-w-4xl mx-auto flex justify-between items-center">
        <h1 class="text-2xl font-header">
          <a href="dashboard.html">CVFish</a>
        </h1>
        <button id="logoutButton" class="btn">
          <span class="material-icons mr-2">logout</span>Logout
        </button>
      </div>
    </header>
    <main class="flex flex-col items-start p-4">
      <div class="max-w-4xl w-full mx-auto p-8 rounded shadow-md text-left">
        <h1 class="text-5xl font-header mb-4">Dashboard</h1>
        <div class="overflow-x-auto w-full">
          <div class="stats lg:stats-horizontal shadow mb-8">
            <div class="stat">
              <div class="stat-title">Applications</div>
              <div class="stat-value" id="totalApplications">0</div>
            </div>
            <div class="stat">
              <div class="stat-title">Offers</div>
              <div class="stat-value" id="totalOffers">0</div>
              <div class="stat-desc" id="offerRate">0% Rate</div>
            </div>
            <div class="stat">
              <div class="stat-title">Rejections</div>
              <div class="stat-value" id="totalRejections">0</div>
              <div class="stat-desc" id="rejectionRate">0% Rate</div>
            </div>
          </div>
        </div>
        <div class="flex mb-4 gap-4">
          <button
            class="btn btn-primary"
            onclick="window.location.href='newjob.html'"
          >
            <span class="material-icons mr-2">add_circle</span>
            New Job
          </button>
        </div>
        <div class="card bg-base-100 p-4 shadow-md w-full">
          <div class="overflow-x-auto">
            <table class="table w-full">
              <thead>
                <tr>
                  <th>JOB</th>
                  <th>STATUS</th>
                  <th>DEADLINE</th>
                </tr>
              </thead>
              <tbody id="jobTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
    <footer class="footer footer-center bg-base-100 text-base-content p-10">
      <nav class="grid grid-flow-col gap-4">
        <a class="link link-hover" href="about.html">About</a>
        <a class="link link-hover" href="cv.html">Create CV</a>
      </nav>
      <aside>
        <p class="text-sm">
          Made with ❤️ & ☕️ by <a href="https://marcbeep.com"><u>Marc</u></a>
        </p>
        <p class="text-xs">
          © 2024
          <a href="https://reeflinklabs.com"><u>ReefLink Labs Limited</u></a
          >, Registered in England and Wales (15783465)<br />
          49 Jamaica Street, Liverpool, England, L1 0AH
        </p>
      </aside>
    </footer>
    <script src="script.js"></script>
    <script>
      function getStatusBadge(status) {
        switch (status) {
          case "submitted cv":
            return '<span class="badge badge-outline status-badge">Submitted CV</span>';
          case "submitted assessment":
            return '<span class="badge badge-outline badge-info status-badge">Submitted Assessment</span>';
          case "submitted interview":
            return '<span class="badge badge-outline badge-warning status-badge">Submitted Interview</span>';
          case "rejected at cv":
          case "rejected at assessment":
          case "rejected at interview":
          case "rejected":
            return '<span class="badge badge-outline badge-error status-badge">Rejected</span>';
          case "offer":
            return '<span class="badge badge-outline badge-success status-badge">Offer</span>';
          case "incomplete":
            return '<span class="badge badge-outline status-badge">Incomplete</span>';
          default:
            return '<span class="badge badge-outline status-badge">Unknown</span>';
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const jobs = await makeFetchRequest("/v1/jobs");
          const jobTableBody = document.getElementById("jobTableBody");
          const totalApplicationsElement =
            document.getElementById("totalApplications");
          const totalOffersElement = document.getElementById("totalOffers");
          const totalRejectionsElement =
            document.getElementById("totalRejections");
          const offerRateElement = document.getElementById("offerRate");
          const rejectionRateElement = document.getElementById("rejectionRate");

          let totalApplications = 0;
          let totalOffers = 0;
          let totalRejections = 0;

          if (jobs.length === 0) {
            const noJobsRow = document.createElement("tr");
            noJobsRow.innerHTML = `<td colspan="3" class="text-center">No jobs. Add your first one.</td>`;
            jobTableBody.appendChild(noJobsRow);
          } else {
            jobs.sort(
              (a, b) => new Date(a.dateApplied) - new Date(b.dateApplied)
            );

            jobs.forEach((job) => {
              totalApplications++;
              if (job.status === "offer") {
                totalOffers++;
              } else if (
                [
                  "rejected at cv",
                  "rejected at assessment",
                  "rejected at interview",
                  "rejected",
                ].includes(job.status)
              ) {
                totalRejections++;
              }

              const row = document.createElement("tr");
              row.innerHTML = `
                <td class="truncate" title="${job.title || "N/A"}">${
                job.title || "N/A"
              }</td>
                <td class="no-truncate">${getStatusBadge(job.status)}</td>
                <td class="no-truncate">${new Date(
                  job.dateApplied
                ).toLocaleDateString()}</td>
              `;
              row.style.cursor = "pointer";
              row.onclick = () =>
                (window.location.href = `jobdetails.html?jobId=${job._id}`);
              jobTableBody.appendChild(row);
            });
          }

          totalApplicationsElement.textContent = totalApplications;
          totalOffersElement.textContent = totalOffers;
          totalRejectionsElement.textContent = totalRejections;

          const offerRate = ((totalOffers / totalApplications) * 100).toFixed(
            2
          );
          const rejectionRate = (
            (totalRejections / totalApplications) *
            100
          ).toFixed(2);

          offerRateElement.textContent = `${offerRate}% Rate`;
          rejectionRateElement.textContent = `${rejectionRate}% Rate`;
        } catch (error) {
          console.error("Error loading dashboard:", error);
          alert("Error loading dashboard. Please try again.");
        }

        document
          .getElementById("logoutButton")
          .addEventListener("click", logoutUser);
      });
    </script>
  </body>
</html>
